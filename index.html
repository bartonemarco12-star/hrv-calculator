<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>HRV Calculator</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<style>
  body { font-family: -apple-system, system-ui, Helvetica, Arial, sans-serif; margin: 0; padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom); }
  header { position: sticky; top: 0; background: white; padding: 12px 0; border-bottom: 1px solid #eee; }
  h1 { margin: 0; font-size: 20px; }
  main { max-width: 760px; margin: 0 auto; padding: 16px 0; }
  textarea { width: 100%; min-height: 160px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; font-size: 16px; }
  button { font-size: 16px; padding: 10px 14px; border-radius: 10px; border: 1px solid #999; background: #f7f7f7; }
  button.primary { background: #007aff; color: white; border-color: #007aff; }
  .row { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
  .card { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-top: 10px; }
  .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  footer { color: #888; font-size: 12px; margin-top: 24px; }
</style>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}

function parseRR(text) {
  const tokens = text.replace(/,/g,'.').split(/[\s,]+/);
  const arr = tokens.map(t => parseFloat(t)).filter(v => Number.isFinite(v) && v > 200 && v < 3000);
  return arr;
}

function computeHRV(rr) {
  if (rr.length < 3) return null;
  const n = rr.length;
  const mean = rr.reduce((a,b)=>a+b,0)/n;
  const variance = rr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n;
  const sdnn = Math.sqrt(variance);

  const diffs = [];
  for (let i=1;i<n;i++) diffs.push(rr[i]-rr[i-1]);

  const rmssd = Math.sqrt(diffs.reduce((a,b)=>a+b*b,0)/diffs.length);
  const nn50 = diffs.filter(d => Math.abs(d) > 50).length;
  const pnn50 = (nn50/diffs.length)*100;

  return { rmssd, sdnn, pnn50 };
}

function onCompute() {
  const input = document.getElementById('rr').value;
  const rr = parseRR(input);
  const out = document.getElementById('out');
  const warn = document.getElementById('warn');
  warn.textContent = '';
  if (rr.length < 3) {
    out.innerHTML = '';
    warn.textContent = 'Inserisci almeno 3 intervalli RR validi in millisecondi.';
    return;
  }
  const res = computeHRV(rr);
  out.innerHTML = `
    <div class="card">
      <h3>Risultati (time-domain)</h3>
      <div>RMSSD: <span class="mono">${res.rmssd.toFixed(2)} ms</span></div>
      <div>SDNN: <span class="mono">${res.sdnn.toFixed(2)} ms</span></div>
      <div>pNN50: <span class="mono">${res.pnn50.toFixed(2)} %</span></div>
    </div>`;
}

function onClear() {
  document.getElementById('rr').value='';
  document.getElementById('out').innerHTML='';
  document.getElementById('warn').textContent='';
}
</script>
</head>
<body>
  <header>
    <h1>HRV Calculator</h1>
  </header>
  <main>
    <p>Incolla gli intervalli <b>RR (ms)</b> separati da spazi, virgole o a capo, quindi premi <em>Calcola</em>.</p>
    <textarea id="rr" placeholder="Esempio: 802 810 795 790 808 820 812 804 799 805"></textarea>
    <div class="row">
      <button class="primary" onclick="onCompute()">Calcola</button>
      <button onclick="onClear()">Pulisci</button>
    </div>
    <div id="warn" style="color:#d00;"></div>
    <div id="out"></div>
    <footer>
      Offline-ready PWA. Aggiungi a Schermata Home in Safari per usarla come app.
    </footer>
  </main>
</body>
</html>
